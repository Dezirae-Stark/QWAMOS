# QWAMOS Development Container
# Development environment with additional tools and debuggers

FROM debian:stable-slim

LABEL maintainer="QWAMOS Team <qwamos@tutanota.com>"
LABEL description="QWAMOS Development Environment"
LABEL version="1.0"

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install system dependencies (same as build + dev tools)
RUN apt-get update && apt-get install -y \
    # Build essentials
    build-essential \
    cmake \
    ninja-build \
    pkg-config \
    autoconf \
    automake \
    libtool \
    # Python 3
    python3 \
    python3-pip \
    python3-dev \
    python3-venv \
    # Version control
    git \
    tig \
    # Networking tools
    curl \
    wget \
    ca-certificates \
    gnupg \
    netcat-openbsd \
    nmap \
    # Compression utilities
    tar \
    gzip \
    bzip2 \
    xz-utils \
    zip \
    unzip \
    # Android development
    default-jdk \
    default-jre-headless \
    android-tools-adb \
    android-tools-fastboot \
    # Flutter dependencies
    clang \
    liblzma-dev \
    # Cryptography libraries
    libssl-dev \
    libsodium-dev \
    # Development tools (minimal set)
    vim \
    nano \
    less \
    htop \
    tree \
    jq \
    sudo \
    # Debuggers (essential only)
    gdb \
    strace \
    && rm -rf /var/lib/apt/lists/*

# Set up workspace
WORKDIR /workspace

# Remove EXTERNALLY-MANAGED marker to allow pip installs (safe in Docker containers)
RUN rm -f /usr/lib/python*/EXTERNALLY-MANAGED

# Install Python packages (development + testing)
# Note: Using system pip without upgrade to avoid Debian externally-managed-environment issues
# Split into smaller groups for better caching and error isolation

# Core packages first
RUN python3 -m pip install --no-cache-dir \
    cryptography \
    pycryptodome

# Testing frameworks
RUN python3 -m pip install --no-cache-dir \
    pytest \
    pytest-cov \
    pytest-xdist \
    pytest-benchmark \
    pytest-timeout \
    hypothesis

# Code quality tools
RUN python3 -m pip install --no-cache-dir \
    black \
    pylint \
    mypy \
    bandit \
    flake8 \
    isort \
    yapf

# Security and build tools
RUN python3 -m pip install --no-cache-dir \
    safety \
    pip-audit \
    build \
    twine

# Development and LSP tools
RUN python3 -m pip install --no-cache-dir \
    ipython \
    ipdb \
    python-lsp-server \
    pylsp-mypy

# Install Kotlin
ENV KOTLIN_VERSION=1.9.20
RUN wget -q https://github.com/JetBrains/kotlin/releases/download/v${KOTLIN_VERSION}/kotlin-compiler-${KOTLIN_VERSION}.zip && \
    unzip kotlin-compiler-${KOTLIN_VERSION}.zip -d /opt && \
    rm kotlin-compiler-${KOTLIN_VERSION}.zip && \
    ln -s /opt/kotlinc/bin/* /usr/local/bin/

# Install Kotlin Language Server
# Note: Commented out due to build timeouts - can be installed manually if needed
# RUN git clone https://github.com/fwcd/kotlin-language-server.git /tmp/kotlin-language-server && \
#     cd /tmp/kotlin-language-server && \
#     ./gradlew :server:installDist && \
#     mkdir -p /opt/kotlin-language-server && \
#     cp -r server/build/install/server/* /opt/kotlin-language-server/ && \
#     ln -s /opt/kotlin-language-server/bin/kotlin-language-server /usr/local/bin/ && \
#     rm -rf /tmp/kotlin-language-server

# Install Flutter SDK
ENV FLUTTER_HOME=/opt/flutter
ENV PATH="${FLUTTER_HOME}/bin:${PATH}"

RUN git clone --depth 1 --branch stable https://github.com/flutter/flutter.git ${FLUTTER_HOME} && \
    flutter --version && \
    flutter config --no-analytics

# Install Android SDK
ENV ANDROID_HOME=/opt/android-sdk
ENV PATH="${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:${PATH}"

RUN mkdir -p ${ANDROID_HOME}/cmdline-tools && \
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip && \
    unzip -q commandlinetools-linux-9477386_latest.zip -d ${ANDROID_HOME}/cmdline-tools && \
    mv ${ANDROID_HOME}/cmdline-tools/cmdline-tools ${ANDROID_HOME}/cmdline-tools/latest && \
    rm commandlinetools-linux-9477386_latest.zip

# Accept Android licenses
RUN yes | sdkmanager --licenses || true

# Install Android SDK components (more complete for dev)
RUN sdkmanager --update && \
    sdkmanager \
    "platform-tools" \
    "platforms;android-34" \
    "platforms;android-33" \
    "build-tools;34.0.0" \
    "build-tools;33.0.2" \
    "ndk;25.2.9519653" \
    "emulator" \
    "system-images;android-34;google_apis;x86_64"

# Install Gradle
ENV GRADLE_VERSION=8.5
ENV GRADLE_HOME=/opt/gradle
ENV PATH="${GRADLE_HOME}/bin:${PATH}"

RUN wget -q https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip && \
    unzip -q gradle-${GRADLE_VERSION}-bin.zip -d /opt && \
    mv /opt/gradle-${GRADLE_VERSION} ${GRADLE_HOME} && \
    rm gradle-${GRADLE_VERSION}-bin.zip

# Install liboqs (Post-Quantum Cryptography)
RUN git clone --depth 1 --branch main https://github.com/open-quantum-safe/liboqs.git /tmp/liboqs && \
    cd /tmp/liboqs && \
    mkdir build && cd build && \
    cmake -GNinja -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=/usr/local .. && \
    ninja && \
    ninja install && \
    ldconfig && \
    rm -rf /tmp/liboqs

# Install Node.js and npm (for various dev tools)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g \
    markdownlint-cli \
    markdown-preview \
    yaml-language-server \
    bash-language-server

# Install ShellCheck
RUN wget -qO- "https://github.com/koalaman/shellcheck/releases/download/stable/shellcheck-stable.linux.x86_64.tar.xz" | \
    tar -xJv -C /tmp && \
    cp /tmp/shellcheck-stable/shellcheck /usr/local/bin/ && \
    rm -rf /tmp/shellcheck-stable

# Verify installations before user switch (as root)
RUN echo "Verifying Python..." && python3 --version && \
    echo "Verifying Java..." && java -version && \
    echo "Verifying Kotlin..." && kotlinc -version && \
    echo "Verifying Flutter..." && flutter --version && \
    echo "Verifying Gradle..." && gradle --version && \
    echo "Verifying Node.js..." && node --version && \
    echo "Verifying npm..." && npm --version && \
    echo "Development environment ready!"

# Set up development user
RUN useradd -m -s /bin/bash -G sudo qwamos && \
    echo "qwamos ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Create common directories
RUN mkdir -p /build_artifacts /workspace && \
    chown -R qwamos:qwamos /build_artifacts /workspace

# Switch to dev user
USER qwamos

# Set up shell (bash with better defaults)
RUN echo 'export PS1="\[\e[32m\]qwamos@docker\[\e[m\]:\[\e[34m\]\w\[\e[m\]\$ "' >> ~/.bashrc && \
    echo 'alias ll="ls -lah"' >> ~/.bashrc && \
    echo 'alias gs="git status"' >> ~/.bashrc && \
    echo 'alias gd="git diff"' >> ~/.bashrc

# Set Java environment (using default JDK)
ENV JAVA_HOME=/usr/lib/jvm/default-java

# Expose common ports for development
EXPOSE 8080 8000 5000 3000

# Default command (keep container running)
CMD ["/bin/bash"]
