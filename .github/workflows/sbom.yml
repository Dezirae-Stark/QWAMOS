# QWAMOS SBOM Generation Workflow
# Automatically generates Software Bill of Materials for transparency and security

name: SBOM Generation

on:
  # Trigger on push to master
  push:
    branches:
      - master
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.github/workflows/doc-sync.yml'
      - '.github/workflows/lint.yml'

  # Trigger on release creation
  release:
    types:
      - created
      - published

  # Manual trigger
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload SBOM to latest release'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag to upload SBOM to (if upload_to_release is true)'
        required: false
        type: string

permissions:
  contents: write
  packages: read
  security-events: write

env:
  SBOM_VERSION: "auto"

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest

    outputs:
      sbom_generated: ${{ steps.generate.outputs.sbom_generated }}
      sbom_version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '\n')
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "Version from VERSION file: ${VERSION}"
          elif git describe --tags --exact-match 2>/dev/null; then
            VERSION=$(git describe --tags --exact-match)
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "Version from git tag: ${VERSION}"
          else
            VERSION="commit-$(git rev-parse --short HEAD)"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "Version from commit: ${VERSION}"
          fi

      - name: Install Syft
        run: |
          echo "::group::Installing Syft"
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft version
          echo "âœ“ Syft installed successfully"
          echo "::endgroup::"

      - name: Generate SBOM files
        id: generate
        run: |
          echo "::group::Generating SBOM files"

          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DIR="sbom/builds/${VERSION}"

          mkdir -p "${BUILD_DIR}"

          echo "Generating SBOM for QWAMOS ${VERSION}..."

          syft dir:. --output json --file "${BUILD_DIR}/sbom.json"
          syft dir:. --output cyclonedx-xml --file "${BUILD_DIR}/sbom.xml"
          syft dir:. --output spdx-json --file "${BUILD_DIR}/sbom.spdx.json"
          syft dir:. --output cyclonedx-json --file "${BUILD_DIR}/sbom.cyclonedx.json"
          syft dir:. --output table --file "${BUILD_DIR}/sbom.txt"

          mkdir -p sbom/latest
          cp "${BUILD_DIR}"/* sbom/latest/

          echo "sbom_generated=true" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Commit SBOM to repository
        if: github.event_name != 'release'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sbom/builds/ sbom/latest/

          if ! git diff --staged --quiet; then
            git commit -m "chore: Update SBOM for ${{ steps.version.outputs.version }}"

            # Pull latest changes before pushing
            git pull --rebase origin master || {
              echo "Rebase failed, attempting merge with conflict resolution..."
              git rebase --abort

              # Try merge with strategy to prefer our changes (SBOM updates are authoritative)
              git pull --no-rebase --strategy-option=ours origin master || {
                echo "Merge with strategy failed, resolving conflicts manually..."

                # Accept our version for all conflicts (SBOM is authoritative)
                git checkout --ours .
                git add -A

                # Check if there are any remaining conflicts
                if git diff --name-only --diff-filter=U | grep -q .; then
                  echo "Error: Unable to resolve all conflicts automatically"
                  git status
                  exit 1
                fi

                # Complete the merge
                git commit --no-edit || echo "No merge commit needed"
              }
            }

            git push origin master
          fi

      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.version.outputs.version }}
          path: sbom/builds/${{ steps.version.outputs.version }}/
          retention-days: 90
