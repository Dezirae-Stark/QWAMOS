name: QWAMOS - Forensic Audit
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: "0 */6 * * *" # every 6 hours

jobs:
  forensic:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect world-writable files
        run: |
          WW=$(find . -type f -perm -0002 | wc -l)
          if [ "$WW" -ne 0 ]; then
            echo "[!] World-writable files detected"
            exit 1
          fi

      - name: Check for debug flags
        run: |
          echo "Checking for debug flags in production code..."
          DEBUG_FLAGS=$(grep -rIn "DEBUG.*=.*true" . \
            --exclude-dir=.git \
            --exclude-dir=node_modules \
            --exclude-dir=docs \
            --exclude-dir=tests \
            --exclude="*.md" 2>/dev/null || true)

          if [ -n "$DEBUG_FLAGS" ]; then
            echo "::warning::Debug flags detected:"
            echo "$DEBUG_FLAGS" | head -10
          else
            echo "✓ No debug flags in production code"
          fi

      - name: Detect suspicious binaries
        run: |
          echo "Checking for binaries in unexpected locations..."
          # Allow binaries in expected build/kernel/bootloader directories
          SUSPICIOUS=$(find . -type f \
            -not -path "./release-packages/*" \
            -not -path "*/.git/*" \
            -not -path "./kernel/*" \
            -not -path "./bootloader/*" \
            -not -path "./build/*" \
            -not -path "./hypervisor/*" \
            -not -path "./vms/*" \
            -not -path "*/node_modules/*" \
            -exec file {} \; 2>/dev/null | grep "ELF" || true)

          if [ -n "$SUSPICIOUS" ]; then
            echo "::warning::ELF binaries found in unexpected locations:"
            echo "$SUSPICIOUS"
          else
            echo "✓ No suspicious binaries detected"
          fi

      - name: Scan for secrets (fast)
        run: |
          egrep -RIn "(api_key|secret|password|BEGIN RSA|PRIVATE KEY)" . || true

      - name: Report completed
        run: echo "Forensic audit completed"
